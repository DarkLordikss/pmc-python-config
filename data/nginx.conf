user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 1024;
	# multi_accept on;
}

http {
	##
	# Basic Settings
	##

	sendfile             on;
	gzip                 on;
	tcp_nopush           on;
	tcp_nodelay          on;
	keepalive_timeout    65;
	types_hash_max_size  2048;
	client_max_body_size 20M;
	
	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	ssl_protocols TLSv3.0;
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;
	error_log  /var/log/nginx/error.log;

	##
	# Proxy Settings
	## 

	proxy_set_header Host            $host;
	proxy_set_header X-Real-IP       $remote_addr;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header X-Request-ID    $request_id;

	##
	# Upstreams
	##

	upstream kollok {
		server kollok:8081;
	}

	# --------------------- #
	#		SERVICES		#
	# --------------------- #

  # kollok.pmc-python.ru

	server {
		listen 80;
		server_name kollok.pmc-python.ru;

		return 301 https://kollok.pmc-python.ru$request_uri;
	}

	server {
		listen 443 ssl;
		listen [::]:443 ssl;

		ssl_certificate /etc/letsencrypt/live/kollok.pmc-python.ru/fullchain.pem;
		ssl_certificate_key /etc/letsencrypt/live/kollok.pmc-python.ru/privkey.pem;
		ssl_trusted_certificate /etc/letsencrypt/live/kollok.pmc-python.ru/chain.pem;

		ssl_stapling on;
		ssl_stapling_verify on;
		resolver 127.0.0.1 8.8.8.8;

		server_name kollok.pmc-python.ru;

		add_header Strict-Transport-Security "max-age=31536000";
		add_header Content-Security-Policy "img-src https: data:; upgrade-insecure-requests";

		location ~ /.well-known/acme-challenge/ {
			root /var/www/certbot;
		}


		location / {
			proxy_pass
		}
	}
}